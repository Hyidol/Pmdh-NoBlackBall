<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>ğŸ¦</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<header align="center">
    <h1>æ¥çƒç§¯åˆ†å°æ¸¸æˆ</h1>
    <h2>æ¸¸æˆä»‹ç»</h2>
    <p>é”®ç›˜å·¦å³æ§åˆ¶ï¼Œæ¥åˆ°çº¢çƒ/ç´«çƒåŠ åˆ†ï¼Œæ¥åˆ°é»‘çƒæ‰£åˆ†ï¼Œåˆ†å€¼æŒ‰ç…§æ¥çƒå‡†ç¡®åº¦å’Œçƒå¤§å°è€Œå®šï¼Œé€šå…³æœ€ä½1000åˆ†ï¼Œ1åˆ†é’Ÿé™æ—¶ã€‚<p>
</header>
<body>
<!--è®¾ç½®èƒŒæ™¯æ–¹æ³•ä¸€ï¼š<div id="background" ><img src="../picture/èƒŒæ™¯.gif" width="100%" height="100%"/></div>-->
<textarea id="log"></textarea>
<canvas id="canvas" width="1080" height="720"></canvas>
<script src="../js/utils.js"></script>
<script src="../js/ball.js"></script>
<script>

    window.onload = function () {
        var canvas = document.getElementById('canvas'),
            context = canvas.getContext('2d'),
            mouse = utils.captureMouse(canvas),  //è®©é¼ æ ‡æ§åˆ¶å°äºº
            log = document.getElementById('log');  //åœ¨æ§åˆ¶çª—å£æ˜¾ç¤º60ç§’å€’è®¡æ—¶

        var score = 0,  //è®°å½•æ¥çƒå¾—åˆ†
            flag = 0,  //è®°å½•æ˜¯å¦æŒ‘æˆ˜æˆåŠŸ
            ax = 0,  //è®°å½•é”®ç›˜æŒ‰é”®æ—¶å€™çš„æ°´å¹³åŠ é€Ÿåº¦
            ay = 0;  //è®°å½•é”®ç›˜æŒ‰é”®æ—¶å€™çš„ç«–ç›´åŠ é€Ÿåº¦

        var ball = createBall(),
            gravity = 0.05,  //é‡åŠ›
            drag = 0.5; //é˜»åŠ›

        var person1 = new Ball();
            person1.color = "#ffdd00";
            person1.radius = 20;
            person1.x = canvas.width / 2;
            person1.y = canvas.height - person1.radius - 25;  // 25æ˜¯è‰åœ°é«˜åº¦

        var person2 = new Ball();
            person2.color = "#bbbbbb";
            person2.radius = 50;
            person2.x = canvas.width / 2;
            person2.y = canvas.height - person2.radius - 25;

        /* æ§åˆ¶å°æ˜¾ç¤ºè®¡æ—¶å™¨ */
        //æ¯éš”1ç§’è®°æ—¶é—´ï¼Œå…±1åˆ†é’Ÿï¼Œæ³¨æ„å•çº¯çš„time++è¡Œä¸é€šã€‚
        for (var i = 1; i <= 60; i++) {
            (function (time) {
                setTimeout(() => {
                    console.log(time);
                    if(time === 60)
                        flag = 1;
                }, 1000 * time);
            })(i);
        }

        /* äººçš„äº‹ä»¶ç›‘å¬å™¨ */
        window.addEventListener('keydown', function (event) {
            switch (event.keyCode) {
                case 37:
                    ax = -0.2;  //åˆå§‹å‘å·¦åŠ é€Ÿåº¦
                    break;
                case 39:
                    ax = 0.2;  //åˆå§‹å‘å³åŠ é€Ÿåº¦
                    break;
            }
        }, false);

        window.addEventListener('keyup', function () {
            ax = 0;
            ay = 0;
        }, false);


        /* åˆ›å»ºå°çƒ */
        function createBall () {
            var ball = new Ball(Math.random() * 50 + 10);  //æ§åˆ¶çƒéšæœºå¤§å°10~60
            ball.color = colourBall();  //æ§åˆ¶çƒéšæœºé¢œè‰²
            ball.x = Math.random() * canvas.width * 3/4 + ball.radius;  //è®©çƒå‡ºç°ç”»å¸ƒçš„3/4éƒ¨åˆ†å‡ºç°ï¼ˆä¸æŒ¡ä½å¤ªé˜³ï¼‰å¹¶ä¸”ä¸è¦æœ‰åŠä¸ªçƒåœ¨å¤–é¢å³å¯
            ball.y = Math.random() * 70 + 10;  //å®šä¹‰å°çƒå‡ºç°çš„åˆå§‹çºµå‘åæ ‡ï¼Œè®©å°çƒä»å¤©ç©ºä¸­å‡ºç°è€Œä¸æ˜¯ç”»å¸ƒæœ€ä¸Šç«¯ï¼ˆè·ç¦»ä¸Šç«¯10~80ï¼‰
            ball.vx = 0;
            ball.vy = 0;
            ball.draw(context);
            return ball;
        }

        /* æœ‰æ¦‚ç‡æ€§åœ°æ”¹å˜å°çƒé¢œè‰² */
        function colourBall() {
            //randomçš„å€¼ä»‹äº0~1ä¹‹é—´
            if(Math.random() > 0.6 && gravity > 0.2) //ååŠå¥æ˜¯æ§åˆ¶é»‘çƒç¨å¾®æ™šç‚¹å‡ºç°
                return "#000";  //æ‰£åˆ†çš„é»‘çƒ
            else if(Math.random() < 0.1 && gravity > 0.8)  //ååŠå¥æ˜¯æ§åˆ¶ç´«çƒæ›´æ™šäº›å‡ºç°
                return "#ff00fc"  //å½©è›‹çš„ç´«çƒ
            else
                return "#ff0000";  //åŠ åˆ†çš„çº¢çƒ
        }

        /* ç¢°æ’æ£€æµ‹ */
        function cashDetection(person,ball) {
            var dx = person.x - ball.x;
            var dy = person.y - ball.y;
            var dist = Math.sqrt(dx * dx + dy * dy);
            var min_dist = person.radius + ball.radius;
            //å¼€å§‹åˆ¤æ–­
            if(dist <= min_dist){
                return dist;
            }
            else{
                return false;
            }
        }

        /* ç¢°æ’ç®—åˆ† */
        function cashScore(ball,dist) {
            var changeScore = 0;

            //æŒ‰çƒè‰²/çƒå¤§å°
            if(ball.color === "#000")  // ç¢°ä¸Šä¸€ä¸ªé»‘çƒæ‰£åˆ†ï¼ˆæ•°å€¼ä»¥çƒå¤§å°ä¸ºå‡†ï¼‰
                changeScore -= ball.radius;
            else if(ball.color === "#ff00fc")  // ç¢°ä¸Šä¸€ä¸ªç´«çƒå¾—åˆ†ï¼ˆæ•°å€¼ä»¥çƒå¤§å°ä¸ºå‡†ï¼‰
                changeScore += ball.radius * 50;
            else if(ball.color === "#ff0000")  // ç¢°ä¸Šä¸€ä¸ªçº¢çƒå¾—åˆ†ï¼ˆæ•°å€¼ä»¥çƒå¤§å°ä¸ºå‡†ï¼‰
                changeScore += ball.radius;

            //æŒ‰æ¥çƒå‡†ç¡®ç‡
            if(dist < ball.radius/100)
                changeScore += dist * 10;
            else if(dist < ball.radius/50)
                changeScore += dist * 5;
            else if(dist < ball.radius/10)
                changeScore += dist * 1;
            else
                changeScore += dist * 0.1;

            return changeScore;
        }

        (function drawFrame () {
            window.requestAnimationFrame(drawFrame, canvas);
            context.clearRect(0, 0, canvas.width, canvas.height);

            /* çƒ */
            ball.y += ball.vy;
            ball.vy += gravity;
            gravity += 0.0001;  //è®©å°çƒæ‰è½çš„é€Ÿåº¦è¶Šæ¥è¶Šå¿«ï¼Œç”±äºéœ€è¦èº²é¿ä¼šå‡ºç°æ‰£åˆ†çš„é»‘çƒï¼Œæ¸¸æˆéš¾åº¦ä¹Ÿä¼šéšç€æ—¶é—´å¢åŠ è€Œå¢åŠ 
            ball.draw(context);

            /* é”®ç›˜æ§åˆ¶å°äºº-1 */
            var dist1 = cashDetection(person1,ball);
            person1.vx += ax;  //å°äººå‡åŒ€æé€Ÿï¼ŒåŠ é€Ÿåº¦ç”±é”®ç›˜æŒ‰ä¸‹æ—¶é•¿å†³å®š
            if(ax===0 && person1.vx>0)
                person1.vx -= drag;  //åœ¨ä¸æŒ‰ä¸‹æ—¶å€™å°äººå‘å·¦æ…¢æ…¢å‡é€Ÿï¼ŒåŠ ä¸Šé˜»åŠ›å˜é‡drag
            if(ax===0 && person1.vx<0)
                person1.vx += drag;  //åœ¨ä¸æŒ‰ä¸‹æ—¶å€™å°äººå‘å³æ…¢æ…¢å‡é€Ÿï¼ŒåŠ ä¸Šé˜»åŠ›å˜é‡drag
            //è¾¹ç•Œæ§åˆ¶ï¼šé‡ä¸Šç”»å¸ƒåˆ™åå¼¹
            if((person1.x - person1.radius) < 0 || (person1.x + person1.radius) > canvas.width){
                person1.vx = -person1.vx; //å°äººç¢°æ’åˆ°ç”»å¸ƒè¾¹ç•Œæ—¶è¢«å¼¹å¼€,å¹¶é€‚å½“å‡é€Ÿï¼Œè¿™é‡Œè®¾ç½®å‡ä¸º1/4
            }
            person1.x += person1.vx;
            person1.draw(context);

            /* é¼ æ ‡æ§åˆ¶å°äºº-2 */
            var dist2 = cashDetection(person2,ball);
            person2.x = mouse.x;
            person2.draw(context);

            /* å®æ—¶ç®—åˆ†æ˜¾ç¤º */
            if(dist1!==false){  //å¦‚æœç¢°æ’ä¸Šäº†é”®æ§å°äºº
                score += cashScore(ball,dist1);  //æŒ‰ç…§çƒè‰²ã€çƒå¤§å°ã€æ¥çƒå‡†ç¡®ç‡è®¡ç®—åˆ†æ•°
                ball = createBall();
            }
            if(dist2!==false){  //å¦‚æœç¢°æ’ä¸Šäº†é¼ æ§å°äºº
                score += cashScore(ball,dist2);  //æŒ‰ç…§çƒè‰²ã€çƒå¤§å°ã€æ¥çƒå‡†ç¡®ç‡è®¡ç®—åˆ†æ•°
                ball = createBall();
            }
            if(ball.y > canvas.height){  //å¦‚æœå°çƒæ‰å‡ºç”»å¸ƒå¤–
                ball = createBall();
            }
            log.value = score; //åœ¨å·¦ä¸‹è§’æ¡†ä¸­æ˜¾ç¤º

            /* æˆåŠŸåå¼¹çª— */
            if(Math.floor(score) >= 1000){
                alert("æ­å–œï¼Œæ‚¨çš„åˆ†æ•°ä¸ºï¼š" + Math.floor(score) + "ã€‚\né€šå…³æˆåŠŸï¼");
                score = 0;
            }
            if(flag === 1 && score < 1000){
                alert("æŠ±æ­‰æ—¶é—´å·²åˆ°ï¼Œæ‚¨çš„åˆ†æ•°ä¸ºï¼š" + Math.floor(score) + "åˆ†ã€‚\næœ€ä½é€šå…³åˆ†æ•°ä¸º1000åˆ†ï¼Œè¯·æŒ‰f5å†æ¥ï¼");
                flag = 0;
                score = 0;
            }

        }());
    };
</script>
</body>
<footer align="center">
    <p> Codeï¼š<a href="https://github.com/Hyidol/FengNu-Person">GitHub</a> || Authorï¼šHyidol || Learn fromï¼šch05-08-acceleration-3 || 04-distance-1</p>
</footer>
</html>